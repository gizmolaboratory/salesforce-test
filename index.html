import React, { useState, useEffect } from 'react';

const SalesforceQuiz = () => {
  const allQuestions = [
    { id: 1, q: "A Sales user is trying to manage Campaign Members. How can an administrator troubleshoot this problem?", opts: ["Create a permission set", "Provide access to Leads and Contacts", "Check Marketing User Checkbox", "Run a Campaign report"], ans: [2] },
    { id: 2, q: "What will happen to data when a custom field is deleted?", opts: ["Stored for 20 days", "Permanently deleted", "Data is required", "Restorable from recycle bin"], ans: [0] },
    { id: 3, q: "Which two steps should troubleshoot field unavailability?", opts: ["Update page layout", "Run setup audit trail", "Update org-wide default", "Review field level security"], ans: [0, 3] },
    { id: 4, q: "How to help team collaborate?", opts: ["Use Quick Actions", "Configure Public Group", "Create Private Group", "Add Activity History"], ans: [2] },
    { id: 5, q: "Which feature requires users to follow status path?", opts: ["Predefined Field Values", "Global Picklists", "Dependent Picklists", "Validation Rules"], ans: [3] },
  ];

  const [state, setState] = useState('start'); // start, quiz, results
  const [round, setRound] = useState(1);
  const [currentQuestions, setCurrentQuestions] = useState([]);
  const [currentIdx, setCurrentIdx] = useState(0);
  const [selectedAnswers, setSelectedAnswers] = useState({});
  const [showAnswer, setShowAnswer] = useState(false);
  const [correctCount, setCorrectCount] = useState(0);
  const [totalCorrect, setTotalCorrect] = useState(0);

  // ë¼ìš´ë“œ ì‹œì‘
  const startQuiz = () => {
    const shuffled = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, 5);
    setCurrentQuestions(shuffled);
    setState('quiz');
    setCurrentIdx(0);
    setSelectedAnswers({});
    setShowAnswer(false);
    setCorrectCount(0);
  };

  // ë‹µë³€ ì„ íƒ
  const handleSelectAnswer = (optIdx) => {
    if (showAnswer) return;
    
    const key = currentIdx;
    const current = selectedAnswers[key] || [];
    let updated;

    if (current.includes(optIdx)) {
      updated = current.filter(idx => idx !== optIdx);
    } else {
      updated = [...current, optIdx];
    }

    setSelectedAnswers({ ...selectedAnswers, [key]: updated });
  };

  // ë‹µë³€ ì œì¶œ
  const handleSubmit = () => {
    const key = currentIdx;
    const selected = (selectedAnswers[key] || []).sort((a, b) => a - b);
    const correct = (currentQuestions[key]?.ans || []).sort((a, b) => a - b);
    
    if (JSON.stringify(selected) === JSON.stringify(correct)) {
      setCorrectCount(correctCount + 1);
    }
    
    setShowAnswer(true);
  };

  // ë‹¤ìŒ ë¬¸ì œ
  const handleNext = () => {
    if (currentIdx < currentQuestions.length - 1) {
      setCurrentIdx(currentIdx + 1);
      setShowAnswer(false);
    } else {
      // ë¼ìš´ë“œ ì™„ë£Œ
      setState('results');
      setTotalCorrect(totalCorrect + correctCount);
    }
  };

  // ë‹¤ìŒ ë¼ìš´ë“œ
  const handleNextRound = () => {
    if (round < 3) {
      setRound(round + 1);
      startQuiz();
    }
  };

  // ì²˜ìŒë¶€í„°
  const handleRestart = () => {
    setState('start');
    setRound(1);
    setTotalCorrect(0);
    setCorrectCount(0);
    setSelectedAnswers({});
  };

  const question = currentQuestions[currentIdx];
  const selected = selectedAnswers[currentIdx] || [];
  const correct = question?.ans || [];
  const isCorrect = JSON.stringify([...selected].sort((a, b) => a - b)) === JSON.stringify([...correct].sort((a, b) => a - b));

  // ì‹œì‘ í™”ë©´
  if (state === 'start') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">Salesforce</h1>
          <h2 className="text-2xl font-semibold text-blue-600 mb-4">Administrator Quiz</h2>
          <p className="text-gray-600 mb-2">248ê°œ ë¬¸ì œ í•™ìŠµ</p>
          <p className="text-sm text-gray-500 mb-8">60ê°œì”© 3ë¼ìš´ë“œë¡œ ì§„í–‰ë©ë‹ˆë‹¤</p>
          <button 
            onClick={startQuiz}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition"
          >
            ì‹œì‘í•˜ê¸° â†’
          </button>
        </div>
      </div>
    );
  }

  // ê²°ê³¼ í™”ë©´
  if (state === 'results') {
    const percentage = Math.round((correctCount / currentQuestions.length) * 100);
    const allDone = round === 3;

    return (
      <div className="min-h-screen bg-gradient-to-br from-green-600 to-teal-600 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
          <div className="text-6xl mb-4">{percentage >= 80 ? 'ğŸ‰' : percentage >= 60 ? 'ğŸ‘' : 'ğŸ’ª'}</div>
          <h2 className="text-3xl font-bold text-gray-800 mb-2">Round {round} ì™„ë£Œ!</h2>
          <div className="bg-blue-50 rounded-lg p-4 mb-6">
            <p className="text-5xl font-bold text-blue-600">{percentage}%</p>
            <p className="text-gray-600 mt-2">{correctCount} / {currentQuestions.length}ê°œ ì •ë‹µ</p>
          </div>

          {!allDone && (
            <div className="bg-purple-50 rounded-lg p-3 mb-6">
              <p className="text-sm text-gray-600">ëˆ„ì  ì ìˆ˜</p>
              <p className="text-2xl font-bold text-purple-600">{totalCorrect + correctCount} / {5 * round}</p>
            </div>
          )}

          {allDone && (
            <div className="bg-green-50 rounded-lg p-4 mb-6">
              <p className="text-lg font-bold text-green-700">ğŸ† ëª¨ë“  ë¼ìš´ë“œ ì™„ë£Œ!</p>
              <p className="text-3xl font-bold text-green-600 mt-2">{Math.round(((totalCorrect + correctCount) / (5 * 3)) * 100)}%</p>
            </div>
          )}

          {!allDone ? (
            <button 
              onClick={handleNextRound}
              className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition"
            >
              Round {round + 1} ì‹œì‘í•˜ê¸°
            </button>
          ) : (
            <button 
              onClick={handleRestart}
              className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition"
            >
              ì²˜ìŒë¶€í„° ë‹¤ì‹œ
            </button>
          )}
        </div>
      </div>
    );
  }

  // í€´ì¦ˆ í™”ë©´
  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-blue-600 p-4">
      <div className="max-w-2xl mx-auto">
        {/* ì§„í–‰ë¥  */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex justify-between items-center mb-4">
            <span className="text-sm font-semibold text-gray-600">Round {round} - Q {currentIdx + 1}/{currentQuestions.length}</span>
            <span className="text-sm font-semibold text-green-600">ì •ë‹µ: {correctCount}</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className="bg-green-500 h-2 rounded-full transition-all"
              style={{width: `${((currentIdx + 1) / currentQuestions.length) * 100}%`}}
            />
          </div>
        </div>

        {/* ë¬¸ì œ ì¹´ë“œ */}
        <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
          <h3 className="text-lg font-bold text-gray-800 mb-6">{question?.q}</h3>

          {/* ì„ íƒì§€ */}
          <div className="space-y-3 mb-6">
            {question?.opts.map((opt, idx) => (
              <button
                key={idx}
                onClick={() => handleSelectAnswer(idx)}
                disabled={showAnswer}
                className={`w-full p-4 text-left rounded-lg font-semibold transition ${
                  showAnswer
                    ? correct.includes(idx)
                      ? 'bg-green-100 border-2 border-green-500 text-green-800'
                      : selected.includes(idx)
                      ? 'bg-red-100 border-2 border-red-500 text-red-800'
                      : 'bg-gray-100 text-gray-600'
                    : selected.includes(idx)
                    ? 'bg-blue-100 border-2 border-blue-500 text-gray-800 cursor-pointer'
                    : 'bg-blue-50 border-2 border-blue-200 text-gray-800 hover:bg-blue-100 cursor-pointer'
                }`}
              >
                <span className="text-sm">{String.fromCharCode(65 + idx)}.</span> {opt}
              </button>
            ))}
          </div>

          {/* ë²„íŠ¼ */}
          {!showAnswer && selected.length > 0 && (
            <button
              onClick={handleSubmit}
              className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition"
            >
              ë‹µë³€ ì œì¶œ
            </button>
          )}

          {showAnswer && (
            <>
              <div className={`p-4 rounded-lg mb-6 ${isCorrect ? 'bg-green-50 border-l-4 border-green-500' : 'bg-red-50 border-l-4 border-red-500'}`}>
                <p className={`font-bold ${isCorrect ? 'text-green-900' : 'text-red-900'}`}>
                  {isCorrect ? 'âœ“ ì •ë‹µì…ë‹ˆë‹¤!' : 'âœ— í‹€ë ¸ìŠµë‹ˆë‹¤'}
                </p>
                {!isCorrect && (
                  <p className="text-sm mt-2 text-gray-800">
                    ì •ë‹µ: {correct.map(i => `${String.fromCharCode(65 + i)}`).join(', ')}
                  </p>
                )}
              </div>
              <button
                onClick={handleNext}
                className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition"
              >
                {currentIdx === currentQuestions.length - 1 ? 'ê²°ê³¼ë³´ê¸°' : 'ë‹¤ìŒ ë¬¸ì œ'} â†’
              </button>
            </>
          )}
        </div>
      </div>
    </div>
  );
};

export default SalesforceQuiz;
